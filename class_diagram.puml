@startuml
' Файл: class_diagram.puml
' Диаграмма классов для "Информационной системы технической экспертизы"
' Архитектура: Domain-Driven Design с ограниченными контекстами (Bounded Contexts) и агрегатами

' ===== BOUNDED CONTEXT 1: Identity & Access =====
package "Контекст управления доступом" <<BoundedContext>> {
  abstract class User {
    + id: UserId
    + username: String
    + passwordHash: String
    + email: String
    + firstName: String
    + lastName: String
    --
    + login()
    + logout()
    + updateProfile()
  }

  class Applicant extends User {
    --
    + submitApplication(applicationData: ApplicationData): ApplicationId
    + viewApplicationStatus(applicationId: ApplicationId): ApplicationStatus
    + withdrawApplication(applicationId: ApplicationId)
  }

  class Expert extends User {
    + specialization: String
    --
    + viewAssignedApplications(): List<ApplicationId>
    + submitEvaluation(evaluationData: EvaluationData): EvaluationId
  }

  class FundHolder extends User {
    + organizationName: String
    --
    + assignExpertToApplication(expertId: UserId, applicationId: ApplicationId)
    + makeDecision(decisionData: DecisionData): DecisionId
    + manageUser(user: User)
  }

  class UserId {
    - value: Long
  }

  User "1" --> "1" UserId
}

' ===== BOUNDED CONTEXT 2: Application Management =====
package "Контекст управления заявками (Агрегат)" <<BoundedContext>> {
  ' Root Aggregate Entity
  class ApplicationAggregate {
    - applicationId: ApplicationId
    - applicantId: UserId
    - title: String
    - description: String
    - submissionDate: Date
    --
    + getStatus(): ApplicationStatus
    + changeStatus(newStatus: ApplicationStatus)
    + withdraw()
    + canBeEvaluated(): Boolean
  }

  class ApplicationId {
    - value: Long
  }

  enum ApplicationStatus {
    SUBMITTED
    UNDER_REVIEW
    EVALUATED
    APPROVED
    REJECTED
    WITHDRAWN
  }

  class ApplicationData <<ValueObject>> {
    - title: String
    - description: String
    - submissionDate: Date
  }

  ' Aggregate composition
  ApplicationAggregate "1" --> "1" ApplicationId
  ApplicationAggregate "1" --> "1" ApplicationStatus
  ApplicationAggregate "1" --> "*" ApplicationData
}

' ===== BOUNDED CONTEXT 3: Evaluation =====
package "Контекст оценки заявок (Агрегат)" <<BoundedContext>> {
  ' Root Aggregate Entity
  class EvaluationAggregate {
    - evaluationId: EvaluationId
    - applicationId: ApplicationId
    - expertId: UserId
    - score: Integer
    - comments: String
    - evaluationDate: Date
    --
    + getScore(): Integer
    + getComments(): String
    + isValid(): Boolean
  }

  class EvaluationId {
    - value: Long
  }

  class EvaluationData <<ValueObject>> {
    - score: Integer
    - comments: String
    - evaluationDate: Date
    --
    + validate(): Boolean
  }

  class ExpertReference <<ValueObject>> {
    - expertId: UserId
    - specialization: String
  }

  ' Aggregate composition
  EvaluationAggregate "1" --> "1" EvaluationId
  EvaluationAggregate "1" --> "1" EvaluationData
  EvaluationAggregate "1" --> "1" ExpertReference
}

' ===== BOUNDED CONTEXT 4: Grant Decision =====
package "Контекст принятия решений по грантам (Агрегат)" <<BoundedContext>> {
  ' Root Aggregate Entity
  class GrantDecisionAggregate {
    - decisionId: DecisionId
    - applicationId: ApplicationId
    - fundHolderId: UserId
    - decisionType: DecisionType
    - justification: String
    - decisionDate: Date
    --
    + getDecision(): DecisionType
    + getJustification(): String
    + approve()
    + reject()
  }

  class DecisionId {
    - value: Long
  }

  enum DecisionType {
    APPROVED
    REJECTED
  }

  class DecisionData <<ValueObject>> {
    - decisionType: DecisionType
    - justification: String
    - decisionDate: Date
  }

  ' Aggregate composition
  GrantDecisionAggregate "1" --> "1" DecisionId
  GrantDecisionAggregate "1" --> "1" DecisionType
  GrantDecisionAggregate "1" --> "1" DecisionData
}

' ===== INTER-CONTEXT REFERENCES (через ID, не через объекты) =====
note right of ApplicationAggregate
  Contains: ApplicationId (PK)
  References: applicantId (UserId)
  ---
  No direct object references
  to other aggregates
end note

note right of EvaluationAggregate
  Contains: EvaluationId (PK)
  References: 
    - applicationId
    - expertId (UserId)
  ---
  Only value objects inside
end note

note right of GrantDecisionAggregate
  Contains: DecisionId (PK)
  References:
    - applicationId
    - fundHolderId (UserId)
  ---
  Aggregate root coordinates
  between contexts
end note

' Связи между контекстами (только через ID, обозначены пунктиром)
ApplicationAggregate "1" ..> ApplicationId : "references"
EvaluationAggregate "1" ..> ApplicationId : "applicationId"
EvaluationAggregate "1" ..> UserId : "expertId"
GrantDecisionAggregate "1" ..> ApplicationId : "applicationId"
GrantDecisionAggregate "1" ..> UserId : "fundHolderId"

' Публикация событий (показаны как зависимости)
ApplicationAggregate ..> "ApplicationSubmitted\nApplicationWithdrawn\nStatusChanged" : "publishes"
EvaluationAggregate ..> "EvaluationCompleted" : "publishes"
GrantDecisionAggregate ..> "DecisionMade" : "publishes"

@enduml
